# Production Cost Exploit Fix ✅

## Exploit Description

**Issue**: Making a cheap item, then adjusting its price to be more expensive while the cost remains the same.

### How It Worked (Vulnerability)

1. User creates a product with price $1.00 → production cost calculated as ~$0.35-$0.67
2. User updates product price to $100.00 → `productionCost` field stays ~$0.35-$0.67
3. User orders batches with the original low production cost, but sells at new high price
4. Result: Massive profit from essentially free production

## Root Cause

The `productionCost` field was stored as an **absolute value** in cents when the product was created:

```typescript
// OLD (vulnerable) - cost was fixed at creation time
const costPercentage = 0.35 + Math.random() * 0.32;
const productionCost = Math.floor(args.price * costPercentage);
```

When the price was later updated via `updateProduct()`, the `productionCost` was NOT recalculated.

## Solution

Changed the schema to store production cost as a **percentage** instead of an absolute value. The actual production cost is now calculated dynamically based on the current price:

### Schema Changes

**Before:**
```typescript
products: {
  price: v.number(),           // in cents
  productionCost: v.number(),  // in cents (VULNERABLE - fixed at creation)
  ...
}
```

**After:**
```typescript
products: {
  price: v.number(),                      // in cents
  productionCostPercentage: v.number(),   // 0-1 (e.g., 0.35 = 35%)
  ...
}
```

### Code Changes

#### 1. Backend (`convex/products.ts`)

**Creating products:** Store the percentage
```typescript
const productionCostPercentage = 0.35 + Math.random() * 0.32;

const productId = await ctx.db.insert("products", {
  ...
  productionCostPercentage: productionCostPercentage,  // Store percentage
  ...
});
```

**Ordering batches:** Calculate cost dynamically
```typescript
const productionCost = Math.floor(product.price * product.productionCostPercentage);
const totalCost = productionCost * args.quantity;
```

#### 2. Frontend (`app/routes/dashboard/company.$companyId.tsx`)

All calculations now derive productionCost from the percentage:
```typescript
// Calculate stats
const totalProductionCosts = products?.reduce(
  (sum, p) => sum + Math.floor(p.price * p.productionCostPercentage) * p.totalSold,
  0
) || 0;

// Batch order calculations
const productionCost = Math.floor(product.price * product.productionCostPercentage);
```

## Impact

✅ **Security**: Production cost is now always based on current price, preventing the exploit
✅ **Fairness**: Players can't lock in cheap production costs then inflate prices
✅ **Consistency**: Production margins stay within 35-67% range regardless of price changes

## Files Modified

1. `convex/schema.ts` - Changed `productionCost` to `productionCostPercentage`
2. `convex/products.ts` - Updated create/order logic to use percentages
3. `app/routes/dashboard/company.$companyId.tsx` - Updated all calculations
4. `convex/__tests__/exploit-part2.test.ts` - Updated test data (6 instances)
5. `convex/__tests__/exploit.test.ts` - Updated test data (1 instance)

## Backward Compatibility

⚠️ **Note**: Existing products in the database will need a migration script to convert:
- Copy `productionCost` → temporary field
- Calculate percentage: `percentage = cost / price`
- Store percentage in `productionCostPercentage`

Migration command (if needed):
```typescript
// One-time migration to populate productionCostPercentage
for each existing product:
  productionCostPercentage = productionCost / price
```

## Testing

All calculations have been verified:
- Production cost stays between 35-67% of selling price ✓
- Price updates don't affect production cost percentage ✓
- Batch order costs recalculate correctly ✓
- Dashboard displays accurate profit margins ✓
